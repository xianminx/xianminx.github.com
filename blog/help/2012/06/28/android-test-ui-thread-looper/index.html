<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:wb="http://open.weibo.com/wb">
<head>
<title>Lucas Xu : Android Test For UI Thread Listeners </title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="language" content="en" />
<link rel="stylesheet" type="text/css" href="/css/default.css" />
<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
<meta property="wb:webmaster" content="85ada6b02f0f02d5" />
<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=4064321344" type="text/javascript" charset="utf-8"></script>

<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32905076-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>














<body>
<div class="page_margins">
  <div id="header">
    <h2><a href="http://xianminx.github.com">Lucas Xu   徐仙明</a></h2>
    <div class="clear"></div>

    <!-- begin: main navigation #nav -->
    <div id="nav">
      <div class="hlist">
        <ul>
          
          <li>
          <a href="/about/">About</a>
          </li>
          
          <li class="active">
          <a href="/">Blog</a>
          </li>
          
          <li>
          <a href="/archives/">Archives</a>
          </li>
          
          <li>
          <a href="/tags/">Categories</a>
          </li>
          
          <li>
          <a href="/other/">Other</a>
          </li>
          
        </ul>
      </div>
    </div>
    <!-- end: main navigation -->
  </div>

  <!-- begin: main content area #main -->
  <div id="main">
    <div id="col1">
      <div id="col1_content">
        <div class="post">
  <h3>Android Test For UI Thread Listeners</h3>


<!-- JiaThis Button BEGIN -->
<div id="ckepop">
  <span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tsina">新浪微博</a>
	<a class="jiathis_button_googleplus">Google+</a>
	<a class="jiathis_button_fb">Facebook</a>
	<a class="jiathis_button_evernote">EverNote</a>
	<a class="jiathis_button_tqq">腾讯微博</a>
	<a href="http://www.jiathis.com/share?uid=1633146" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1336370704363698" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!-- UJian Button BEGIN -->
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide"></script>
<!-- UJian Button END -->

<script type="text/javascript">
var jiathis_config = {
    shareImg:{
        "showType":"ALL",
        "bgColor":"",
        "txtColor":"",
        "text":"",
        "services":"",
        "position":"",
        "imgwidth":"",
        "imgheight":"",
        "divname":""
    }
}
</script>
<script type='text/javascript' src='http://v2.jiathis.com/code/jia.js?uid=1336370704363698' charset='utf-8'></script>



<br/>

  <p>The other day I wrote an Android downloading service running in a separate process. The main application process will send command/message to the downloading process asking it to download item. The downloading process is supposed to post back the downloading process and status to the main applicaiton process by sending messages. Everything works fine: the application process can send command and downloading process can receive the command and then start downloading the item. Also the application process can also receives the process update messages from the donwloading process. </p>

<p>For the sake of recursive testing, namely, I wrote the following test case, following the direction specified by <a href="http://developer.android.com/tools/testing/testing_android.html">Android SDK documentation</a>. 
Then run in Eclipse, everything worked fine, and I didnot put much effort on it, it got into the source depot.   </p>
<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadAgentTest</span> <span class="kd">extends</span>
        <span class="n">ActivityInstrumentationTestCase2</span><span class="o">&lt;</span><span class="n">UtActivity</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOG_TAG</span> <span class="o">=</span> <span class="n">DownloadAgentTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="kd">public</span> <span class="nf">DownloadAgentTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">&quot;com.example&quot;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">ut</span><span class="o">.</span><span class="na">UtActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setUp</span><span class="o">();</span>
        <span class="n">mActivity</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">();</span>
        <span class="n">mContext</span> <span class="o">=</span> <span class="n">mActivity</span><span class="o">.</span><span class="na">getBaseContext</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">UtActivity</span> <span class="n">mActivity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Context</span> <span class="n">mContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDownloadAgent</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">CountDownLatch</span> <span class="n">signal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="n">IDownloadListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IDownloadListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onStart&quot;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onProgressUpdate</span><span class="o">(</span><span class="kt">int</span> <span class="n">progress</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onProgressUpdate(&quot;</span><span class="o">+</span><span class="n">progress</span> <span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEnd</span><span class="o">(</span><span class="kt">int</span> <span class="n">result</span><span class="o">,</span> <span class="n">String</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onEnd(&quot;</span><span class="o">+</span><span class="n">result</span> <span class="o">+</span><span class="s">&quot;, &quot;</span><span class="o">+</span> <span class="n">file</span> <span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">result</span> <span class="o">==</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;/sdcard/&quot;</span><span class="o">));</span>
                <span class="n">signal</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">};</span>
        <span class="n">DownloadAgent</span> <span class="n">agent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DownloadAgent</span><span class="o">(</span>
                <span class="n">mContext</span><span class="o">,</span>
                <span class="s">&quot;xp&quot;</span><span class="o">,</span>
                <span class="s">&quot;App_name&quot;</span><span class="o">,</span>
                <span class="s">&quot;http://www.google.com/some.apk&quot;</span><span class="o">,</span>
                <span class="n">listener</span><span class="o">);</span>
        <span class="n">agent</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">signal</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre>
</div>

<p>Days later, one of my collegues read that code, run it, but asked: &quot;How do you know functions <code>onProgressUpdate</code> and <code>onEnd</code> are called?&quot;. Inspired by his question, I updated the code as：</p>
<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadAgentTest</span> <span class="kd">extends</span>
        <span class="n">ActivityInstrumentationTestCase2</span><span class="o">&lt;</span><span class="n">UtActivity</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOG_TAG</span> <span class="o">=</span> <span class="n">DownloadAgentTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="n">onStartTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">onProgressUpdateTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">onEndTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DownloadAgentTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">&quot;com.example&quot;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">ut</span><span class="o">.</span><span class="na">UtActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setUp</span><span class="o">();</span>
        <span class="n">mActivity</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">();</span>
        <span class="n">mContext</span> <span class="o">=</span> <span class="n">mActivity</span><span class="o">.</span><span class="na">getBaseContext</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">UtActivity</span> <span class="n">mActivity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Context</span> <span class="n">mContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDownloadAgent</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">CountDownLatch</span> <span class="n">signal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="n">onStartTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">onProgressUpdateTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">onEndTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="n">IDownloadListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IDownloadListener</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onStart&quot;</span><span class="o">);</span>
                            <span class="n">onStartTriggered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onProgressUpdate</span><span class="o">(</span><span class="kt">int</span> <span class="n">progress</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onProgressUpdate(&quot;</span><span class="o">+</span><span class="n">progress</span> <span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
                            <span class="n">onProgressUpdateTriggered</span> <span class="o">=</span><span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEnd</span><span class="o">(</span><span class="kt">int</span> <span class="n">result</span><span class="o">,</span> <span class="n">String</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">onEndTriggered</span> <span class="o">=</span><span class="kc">true</span><span class="o">;</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onEnd(&quot;</span><span class="o">+</span><span class="n">result</span> <span class="o">+</span><span class="s">&quot;, &quot;</span><span class="o">+</span> <span class="n">file</span> <span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
                            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">result</span> <span class="o">==</span><span class="mi">1</span><span class="o">);</span>
                            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;/sdcard/&quot;</span><span class="o">));</span>
                            <span class="n">signal</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                        <span class="o">}</span>
            <span class="o">};</span>  

        <span class="n">DownloadAgent</span> <span class="n">agent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DownloadAgent</span><span class="o">(</span>
                <span class="n">mContext</span><span class="o">,</span>
                <span class="s">&quot;xp&quot;</span><span class="o">,</span>
                <span class="s">&quot;App_name&quot;</span><span class="o">,</span>
                <span class="s">&quot;http://www.google.com/some.apk&quot;</span><span class="o">,</span>
                <span class="n">listener</span><span class="o">);</span>
        <span class="n">agent</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">signal</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">onStartTriggered</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">onProgressUpdateTriggered</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">onEndTriggered</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre>
</div>

<p>Here I add 3 class variables <code>onStartTriggered</code>, <code>onProgressUpdateTriggered</code>, <code>onEndTriggered</code> to track whether each method is successfully called. And in <code>try catch</code> block, use <code>Assert.assertTrue</code> to make sure these variables were accessed by correspondent methods after <code>signal.await</code> call. But unfortunately, this time I am not lucky enough. The test case failed. 
After digging into the code, I found these 3 methods were not called at all. That was tricky, they can be successfuly called in the applicaiton code, but not in the test!
With a few Google search, I found this diagram on StackOverflow.  Thread:<a href="http://stackoverflow.com/questions/6445247/intent-resolved-to-different-process-when-running-unit-test-in-android"> Intent resolved to different process when running Unit Test in Android</a></p>

<p><img src="http://i.stack.imgur.com/5cjBh.png" alt="Instrumentation runs all of your application components in the same process."></p>

<p>The diagram explained the phenomenon to some extent. 
The test runner is running in a sparate thread than the UI thread. What this hint is that the test runner thread has no looper, which is required for Android message communication mechanism. See <a href="http://developer.android.com/reference/android/os/Looper.html">andorid.os.Looper</a>. </p>

<p>As it infers, the runner thread has no looper, thus <code>IDownloadListener listener</code>, which was implemented using the <code>Messager</code> in android to receive messages from downloading process, cannot receives message. As a result, in the test code, the above 3 methods were not called. </p>

<p>But then how can we test that code? The solution is simple, move the listener code to UI thread. In fact, Android Test framework does support this. <a href="http://developer.android.com/tools/testing/activity_testing.html#RunOnUIThread">Testing on the UI thread</a>. </p>

<p>As illustrated in the following code snippet: </p>
<div class="highlight"><pre><code class="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadAgentTest</span> <span class="kd">extends</span>
        <span class="n">ActivityInstrumentationTestCase2</span><span class="o">&lt;</span><span class="n">UtActivity</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOG_TAG</span> <span class="o">=</span> <span class="n">DownloadAgentTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="n">onStartTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">onProgressUpdateTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">onEndTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DownloadAgentTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="s">&quot;com.example&quot;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">ut</span><span class="o">.</span><span class="na">UtActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setUp</span><span class="o">();</span>
        <span class="n">mActivity</span> <span class="o">=</span> <span class="n">getActivity</span><span class="o">();</span>
        <span class="n">mContext</span> <span class="o">=</span> <span class="n">mActivity</span><span class="o">.</span><span class="na">getBaseContext</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">UtActivity</span> <span class="n">mActivity</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Context</span> <span class="n">mContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDownloadAgent</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">CountDownLatch</span> <span class="n">signal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="n">onStartTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">onProgressUpdateTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">onEndTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="n">mActivity</span><span class="o">.</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">IDownloadListener</span> <span class="n">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IDownloadListener</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onStart&quot;</span><span class="o">);</span>
                            <span class="n">onStartTriggered</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onProgressUpdate</span><span class="o">(</span><span class="kt">int</span> <span class="n">progress</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onProgressUpdate(&quot;</span><span class="o">+</span><span class="n">progress</span> <span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
                            <span class="n">onProgressUpdateTriggered</span> <span class="o">=</span><span class="kc">true</span><span class="o">;</span>
                        <span class="o">}</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEnd</span><span class="o">(</span><span class="kt">int</span> <span class="n">result</span><span class="o">,</span> <span class="n">String</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">onEndTriggered</span> <span class="o">=</span><span class="kc">true</span><span class="o">;</span>
                            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onEnd(&quot;</span><span class="o">+</span><span class="n">result</span> <span class="o">+</span><span class="s">&quot;, &quot;</span><span class="o">+</span> <span class="n">file</span> <span class="o">+</span><span class="s">&quot;)&quot;</span><span class="o">);</span>
                            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">result</span> <span class="o">==</span><span class="mi">1</span><span class="o">);</span>
                            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;/sdcard/&quot;</span><span class="o">));</span>
                            <span class="n">signal</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">};</span>

                <span class="n">DownloadAgent</span> <span class="n">agent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DownloadAgent</span><span class="o">(</span>
                        <span class="n">mContext</span><span class="o">,</span>
                        <span class="s">&quot;xp&quot;</span><span class="o">,</span>
                        <span class="s">&quot;App_name&quot;</span><span class="o">,</span>
                        <span class="s">&quot;http://www.google.com/some.apk&quot;</span><span class="o">,</span>
                        <span class="n">listener</span><span class="o">);</span>
                <span class="n">agent</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
              <span class="o">}</span>
          <span class="o">});</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">signal</span><span class="o">.</span><span class="na">await</span><span class="o">(</span><span class="mi">300</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">onStartTriggered</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">onProgressUpdateTriggered</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">onEndTriggered</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre>
</div>

<p>This time it works fine. </p>

<blockquote>
<p>Caution:
Although <a href="http://developer.android.com/tools/testing/activity_testing.html#RunOnUIThread">Testing on the UI thread</a> tells that you can use both <code>@UIThreadTest</code> annotation and <code>mActivity.runOnUiThread(new Runnable()</code> to run some code on UI thread, in the case I mentioned above, do not use the first solution. 
Our code use 
<code>java
                        signal.await(300, TimeUnit.SECONDS);
</code>
to synchronize. So if we put <code>@UIThreadTest</code> annotation, <code>listener</code> will not be executed, as <code>await</code> will block the main UI thread. The <code>Looper</code> is blocked, it cannot receive messages!. </p>
</blockquote>

</div>

<small class="meta final">
  28 Jun 2012
  
   | 
  <a href='/tags#android'>android</a>
  

</small>
<!-- 新浪微薄 评论箱 -->
<script type="text/javascript">
(function(){
var url = "http://widget.weibo.com/distribution/comments.php?width=0&url=auto&ralateuid=2063991842&appkey=4064321344&dpc=1";
url = url.replace("url=auto", "url=" + document.URL); 
document.write('<iframe id="WBCommentFrame" src="' + url + '" scrolling="no" frameborder="0" style="width:100%"></iframe>');
})();
</script>
<script src="http://tjs.sjs.sinajs.cn/open/widget/js/widget/comment.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
window.WBComment.init({
    "id": "WBCommentFrame"
});
</script>
<!-- 新浪微薄 评论箱 -->


<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32905076-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

      </div>
    </div>
    <div id="col3">
      <div id="col3_content">
        <h6 class="vlist">GitHub projects</h6>
        <ul class="vlist">
        	<li>
			<a href="https://github.com/xianminx/PullToRefresh-ListView" >PullToRefresh-ListView</a>
		</li>
	</ul>
        <h6 class="vlist">Misc. Links</h6>
        <ul class="vlist">
          <li>
            <a
              href="http://android-developers.blogspot.com/"
              ><img src="http://android-developers.blogspot.kr/favicon.ico"/>Android Developers Blog</a>
          </li>
           <li>
            <a
              href="http://saigeethamn.blogspot.com/"
              ><img src="https://www.blogger.com/img/logo-16.png"/> Sai Geetha's Android blog</a>
          </li>
          <li>
            <a
              href="http://jon.oberheide.org/blog/"
              ><img src="https://encrypted-tbn2.google.com/images?q=tbn:ANd9GcRo9pLd2k2lx_xG3T0uA7DgpZ0Guu9FMWHPLi5cDeVayZ7uNO0X" height="16" width="16"/>JON.OBERHEIDE.ORG</a>
          </li>
          </ul>

<!-- AddThis Follow BEGIN -->
<h6 class="vlist">Follow Me</h6>
<br/>
<div class="addthis_toolbox addthis_32x32_style addthis_default_style">
<a class="addthis_button_google_follow" addthis:userid="101226668323584222394"></a>
<a class="addthis_button_facebook_follow" addthis:userid="xianminx"></a>
<a class="addthis_button_linkedin_follow" addthis:userid="xianminx"></a>
<a class="addthis_button_twitter_follow" addthis:userid="xianminx"></a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4fdf49b46dac2571"></script>
<!-- AddThis Follow END -->

<br/>

<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=300&skin=1&isTitle=1&noborder=0&isWeibo=1&isFans=1&uid=2063991842&verifier=e0e8dc08&dpc=1"></iframe>


</div>
    </div>
    <div class="clear"></div>
  </div>
  <!-- end: #main -->

  <!-- begin: #footer -->
  <div id="footer">
    <div class="hlist">
      <ul>
        
        <li>
        <a href="/about/"
        
        >About</a>
         | 
        </li>
        
        <li class="active">
        <a href="/"
        
        >Blog</a>
         | 
        </li>
        
        <li>
        <a href="/archives/"
        
        >Archives</a>
         | 
        </li>
        
        <li>
        <a href="/tags/"
        
        >Categories</a>
         | 
        </li>
        
        <li>
        <a href="/other/"
        
        >Other</a>
        
        </li>
        
        <li>&ndash; updated 2012-07-31</li>
      </ul>
    </div>
  </div>
  <!-- end: #footer -->

</div>

</body>
</html>
