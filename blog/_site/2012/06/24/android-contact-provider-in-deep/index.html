<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:wb="http://open.weibo.com/wb">
<head>
<title>Lucas Xu : Android Contacts Provider In Deep </title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="language" content="en" />
<link rel="stylesheet" type="text/css" href="/css/default.css" />
<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
<meta property="wb:webmaster" content="85ada6b02f0f02d5" />
<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=4064321344" type="text/javascript" charset="utf-8"></script>
</head>














<body>
<div class="page_margins">
  <div id="header">
    <h2><a href="http://xianminx.github.com">Lucas Xu   徐仙明</a></h2>
    <div class="clear"></div>

    <!-- begin: main navigation #nav -->
    <div id="nav">
      <div class="hlist">
        <ul>
          
          <li>
          <a href="/about/">About</a>
          </li>
          
          <li class="active">
          <a href="/">Blog</a>
          </li>
          
          <li>
          <a href="/archives/">Archives</a>
          </li>
          
          <li>
          <a href="/tags/">Categories</a>
          </li>
          
          <li>
          <a href="/other/">Other</a>
          </li>
          
          <li><a href="http://github.com/xianminx">Repositories</a></li>
        </ul>
      </div>
    </div>
    <!-- end: main navigation -->
  </div>

  <!-- begin: main content area #main -->
  <div id="main">
    <div id="col1">
      <div id="col1_content">
        <div class="post">
  <h3>Android Contacts Provider In Deep</h3>


<!-- JiaThis Button BEGIN -->
<div id="ckepop">
  <span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tsina">新浪微博</a>
	<a class="jiathis_button_googleplus">Google+</a>
	<a class="jiathis_button_fb">Facebook</a>
	<a class="jiathis_button_evernote">EverNote</a>
	<a class="jiathis_button_tqq">腾讯微博</a>
	<a href="http://www.jiathis.com/share?uid=1633146" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1336370704363698" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!-- UJian Button BEGIN -->
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide"></script>
<!-- UJian Button END -->

<script type="text/javascript">
var jiathis_config = {
    shareImg:{
        "showType":"ALL",
        "bgColor":"",
        "txtColor":"",
        "text":"",
        "services":"",
        "position":"",
        "imgwidth":"",
        "imgheight":"",
        "divname":""
    }
}
</script>
<script type='text/javascript' src='http://v2.jiathis.com/code/jia.js?uid=1336370704363698' charset='utf-8'></script>



<br/>

  <p>Android contact API uses Content Provider to provide data for application. The service is provided by <code>com.android.providers.contacts</code>. All the contact data are stored in SQLite database. You can find all the data under <code>/data/data/com.android.providers.contacts/databases</code>, as following:</p>
<div class="highlight"><pre><code class="bash"><span class="c"># adb shell </span>
root@android:/data/data/com.android.providers.contacts/databases <span class="c"># ls</span>
contacts2.db
contacts2.db-journal
contacts2.db-mj6E07C4A4
profile.db
profile.db-journal
</code></pre>
</div>

<p>The most important and the central database here is <code>contacts2.db</code>. To view what&#39;s in this database, you can utilize the tool called <code>sqlite3</code> provided by Google. This is the <a href="http://developer.android.com/tools/help/sqlite3.html">link</a> to the official description of the tool.  This tool is under /system/bin/ by default in Android. But in case you cannot find it on you device, you can use Eclipse SQLite Plugin to visualize the table structure and data. See this article <a href="http://www.tylerfrankenstein.com/browse-android-emulator-sqlite-database-eclipse">Browse an Android Emulator SQLite Database in Eclipse</a>for help. </p>

<p>To view the db under command line, execute: </p>
<div class="highlight"><pre><code class="bash"><span class="c"># sqlite3 contacts2.db </span>

sqlite&gt; .tables
_sync_state               phone_lookup              view_data              
_sync_state_metadata      photo_files               view_data_usage_stat   
accounts                  properties                view_entities          
activities                raw_contacts              view_groups            
agg_exceptions            search_index              view_raw_contacts      
android_metadata          search_index_content      view_raw_entities      
calls                     search_index_docsize      view_stream_items      
contacts                  search_index_segdir       view_v1_contact_methods
data                      search_index_segments     view_v1_extensions     
data_usage_stat           search_index_stat         view_v1_group_membership
default_directory         settings                  view_v1_groups         
directories               status_updates            view_v1_organizations  
groups                    stream_item_photos        view_v1_people         
mimetypes                 stream_items              view_v1_phones         
name_lookup               t9_lookup                 view_v1_photos         
nickname_lookup           v1_settings               visible_contacts       
packages                  view_contacts             voicemail_status  
</code></pre>
</div>

<p>3 most important tables are <code>contacts</code>, <code>raw_contacts</code> and <code>data</code>.</p>

<p>For a explaination of these 3 tables, see <a href="http://developer.android.com/guide/topics/providers/contacts-provider.html">Contact Provider</a></p>

<p>Let&#39;s take a look at the schema of the tables: </p>
<div class="highlight"><pre><code class="bash">sqlite&gt; .schema contacts
CREATE TABLE contacts <span class="o">(</span>_id INTEGER PRIMARY KEY AUTOINCREMENT,name_raw_contact_id INTEGER REFERENCES raw_contacts<span class="o">(</span>_id<span class="o">)</span>,photo_id INTEGER REFERENCES data<span class="o">(</span>_id<span class="o">)</span>,photo_file_id INTEGER REFERENCES photo_files<span class="o">(</span>_id<span class="o">)</span>,custom_ringtone TEXT,send_to_voicemail INTEGER NOT NULL DEFAULT 0,times_contacted INTEGER NOT NULL DEFAULT 0,last_time_contacted INTEGER,starred INTEGER NOT NULL DEFAULT 0,has_phone_number INTEGER NOT NULL DEFAULT 0,lookup TEXT,company TEXT,nickname TEXT,contact_account_type TEXT,status_update_id INTEGER REFERENCES data<span class="o">(</span>_id<span class="o">))</span>;
CREATE INDEX contacts_has_phone_index ON contacts <span class="o">(</span>has_phone_number<span class="o">)</span>;
CREATE INDEX contacts_name_raw_contact_id_index ON contacts <span class="o">(</span>name_raw_contact_id<span class="o">)</span>;
</code></pre>
</div>
<div class="highlight"><pre><code class="bash">sqlite&gt; .schema raw_contacts
CREATE TABLE raw_contacts <span class="o">(</span>_id INTEGER PRIMARY KEY AUTOINCREMENT,account_name STRING DEFAULT NULL, account_type STRING DEFAULT NULL, data_set STRING DEFAULT NULL, sourceid TEXT,raw_contact_is_read_only INTEGER NOT NULL DEFAULT 0,version INTEGER NOT NULL DEFAULT 1,dirty INTEGER NOT NULL DEFAULT 0,deleted INTEGER NOT NULL DEFAULT 0,contact_id INTEGER REFERENCES contacts<span class="o">(</span>_id<span class="o">)</span>,aggregation_mode INTEGER NOT NULL DEFAULT 0,aggregation_needed INTEGER NOT NULL DEFAULT 1,custom_ringtone TEXT,send_to_voicemail INTEGER NOT NULL DEFAULT 0,times_contacted INTEGER NOT NULL DEFAULT 0,last_time_contacted INTEGER,starred INTEGER NOT NULL DEFAULT 0,display_name TEXT,display_name_alt TEXT,display_name_source INTEGER NOT NULL DEFAULT 0,phonetic_name TEXT,phonetic_name_style TEXT,sort_key TEXT COLLATE PHONEBOOK,sort_key_alt TEXT COLLATE PHONEBOOK,sort_key_custom TEXT COLLATE PHONEBOOK,name_verified INTEGER NOT NULL DEFAULT 0,sync1 TEXT, sync2 TEXT, sync3 TEXT, sync4 TEXT <span class="o">)</span>;
CREATE INDEX raw_contact_sort_key1_index ON raw_contacts <span class="o">(</span>sort_key<span class="o">)</span>;
CREATE INDEX raw_contact_sort_key2_index ON raw_contacts <span class="o">(</span>sort_key_alt<span class="o">)</span>;
CREATE INDEX raw_contact_sort_key_custom_index ON raw_contacts <span class="o">(</span>sort_key_custom<span class="o">)</span>;
CREATE INDEX raw_contacts_contact_id_index ON raw_contacts <span class="o">(</span>contact_id<span class="o">)</span>;
CREATE INDEX raw_contacts_source_id_data_set_index ON raw_contacts <span class="o">(</span>sourceid, account_type, account_name, data_set<span class="o">)</span>;
CREATE INDEX raw_contacts_source_id_index ON raw_contacts <span class="o">(</span>sourceid, account_type, account_name<span class="o">)</span>;
CREATE TRIGGER raw_contacts_deleted    BEFORE DELETE ON raw_contacts BEGIN    DELETE FROM data     WHERE <span class="nv">raw_contact_id</span><span class="o">=</span>OLD._id;   DELETE FROM agg_exceptions     WHERE <span class="nv">raw_contact_id1</span><span class="o">=</span>OLD._id        OR <span class="nv">raw_contact_id2</span><span class="o">=</span>OLD._id;   DELETE FROM visible_contacts     WHERE <span class="nv">_id</span><span class="o">=</span>OLD.contact_id       AND <span class="o">(</span>SELECT COUNT<span class="o">(</span>*<span class="o">)</span> FROM raw_contacts            WHERE <span class="nv">contact_id</span><span class="o">=</span>OLD.contact_id           <span class="o">)=</span>1;   DELETE FROM default_directory     WHERE <span class="nv">_id</span><span class="o">=</span>OLD.contact_id       AND <span class="o">(</span>SELECT COUNT<span class="o">(</span>*<span class="o">)</span> FROM raw_contacts            WHERE <span class="nv">contact_id</span><span class="o">=</span>OLD.contact_id           <span class="o">)=</span>1;   DELETE FROM contacts     WHERE <span class="nv">_id</span><span class="o">=</span>OLD.contact_id       AND <span class="o">(</span>SELECT COUNT<span class="o">(</span>*<span class="o">)</span> FROM raw_contacts            WHERE <span class="nv">contact_id</span><span class="o">=</span>OLD.contact_id           <span class="o">)=</span>1; END;
CREATE TRIGGER raw_contacts_marked_deleted    AFTER UPDATE ON raw_contacts BEGIN    UPDATE raw_contacts     SET <span class="nv">version</span><span class="o">=</span>OLD.version+1      WHERE <span class="nv">_id</span><span class="o">=</span>OLD._id       AND NEW.deleted!<span class="o">=</span> OLD.deleted; END;
</code></pre>
</div>
<div class="highlight"><pre><code class="bash">sqlite&gt; .schema data
CREATE TABLE data <span class="o">(</span>_id INTEGER PRIMARY KEY AUTOINCREMENT,package_id INTEGER REFERENCES package<span class="o">(</span>_id<span class="o">)</span>,mimetype_id INTEGER REFERENCES mimetype<span class="o">(</span>_id<span class="o">)</span> NOT NULL,raw_contact_id INTEGER REFERENCES raw_contacts<span class="o">(</span>_id<span class="o">)</span> NOT NULL,is_read_only INTEGER NOT NULL DEFAULT 0,is_primary INTEGER NOT NULL DEFAULT 0,is_super_primary INTEGER NOT NULL DEFAULT 0,data_version INTEGER NOT NULL DEFAULT 0,data1 TEXT,data2 TEXT,data3 TEXT,data4 TEXT,data5 TEXT,data6 TEXT,data7 TEXT,data8 TEXT,data9 TEXT,data10 TEXT,data11 TEXT,data12 TEXT,data13 TEXT,data14 TEXT,data15 TEXT,data_sync1 TEXT, data_sync2 TEXT, data_sync3 TEXT, data_sync4 TEXT <span class="o">)</span>;
CREATE INDEX data_mimetype_data1_index ON data <span class="o">(</span>mimetype_id,data1<span class="o">)</span>;
CREATE INDEX data_raw_contact_id ON data <span class="o">(</span>raw_contact_id<span class="o">)</span>;
CREATE TRIGGER data_deleted BEFORE DELETE ON data BEGIN    UPDATE raw_contacts     SET <span class="nv">version</span><span class="o">=</span>version+1      WHERE <span class="nv">_id</span><span class="o">=</span>OLD.raw_contact_id;   DELETE FROM phone_lookup     WHERE <span class="nv">data_id</span><span class="o">=</span>OLD._id;   DELETE FROM status_updates     WHERE <span class="nv">status_update_data_id</span><span class="o">=</span>OLD._id;   DELETE FROM name_lookup     WHERE <span class="nv">data_id</span><span class="o">=</span>OLD._id; END;
CREATE TRIGGER data_updated AFTER UPDATE ON data BEGIN    UPDATE data     SET <span class="nv">data_version</span><span class="o">=</span>OLD.data_version+1      WHERE <span class="nv">_id</span><span class="o">=</span>OLD._id;   UPDATE raw_contacts     SET <span class="nv">version</span><span class="o">=</span>version+1      WHERE <span class="nv">_id</span><span class="o">=</span>OLD.raw_contact_id; END;
</code></pre>
</div>

<p>To visiualize the table, here is the screen short from Eclipse SQlite Plugin:</p>

<p><img src="/graphics/8c440d12df2a8bb8a7b680760caa1fc5.jpeg" alt="contacts table" title="contacts table"></p>

<p><img src="/graphics/1f4498dfd10cb507e2f1675cf81d393d.jpeg" alt="raw_contacts table" title="raw_contacts table"></p>

<p><img src="/graphics/756d755e09fc682fe5f6814f73edb0ca.jpeg" alt="data table" title="data table"></p>

</div>

<small class="meta final">
  24 Jun 2012
  
   | 
  <a href='/tags#android'>android</a>
  

</small>


      </div>
    </div>
    <div id="col3">
      <div id="col3_content">
        <h6 class="vlist">GitHub projects</h6>
        <ul class="vlist">
        	<li>
			<a href="https://github.com/xianminx/PullToRefresh-ListView" >PullToRefresh-ListView</a>
		</li>
	</ul>
        <h6 class="vlist">Misc. Links</h6>
        <ul class="vlist">
          <li>
            <a
              href="http://www.google.com/"
              >Google</a>
          </li>
          </ul>

<!-- AddThis Follow BEGIN -->
<h6 class="vlist">Follow Me</h6>
<br/>
<div class="addthis_toolbox addthis_32x32_style addthis_default_style">
<a class="addthis_button_google_follow" addthis:userid="101226668323584222394"></a>
<a class="addthis_button_facebook_follow" addthis:userid="xianminx"></a>
<a class="addthis_button_linkedin_follow" addthis:userid="xianminx"></a>
<a class="addthis_button_twitter_follow" addthis:userid="xianminx"></a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4fdf49b46dac2571"></script>
<!-- AddThis Follow END -->

<br/>

<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=300&skin=1&isTitle=1&noborder=0&isWeibo=1&isFans=1&uid=2063991842&verifier=e0e8dc08&dpc=1"></iframe>


</div>
    </div>
    <div class="clear"></div>
  </div>
  <!-- end: #main -->

  <!-- begin: #footer -->
  <div id="footer">
    <div class="hlist">
      <ul>
        
        <li>
        <a href="/about/"
        
        >About</a>
         | 
        </li>
        
        <li class="active">
        <a href="/"
        
        >Blog</a>
         | 
        </li>
        
        <li>
        <a href="/archives/"
        
        >Archives</a>
         | 
        </li>
        
        <li>
        <a href="/tags/"
        
        >Categories</a>
         | 
        </li>
        
        <li>
        <a href="/other/"
        
        >Other</a>
        
        </li>
        
        <li>&ndash; updated 2012-06-24</li>
      </ul>
    </div>
  </div>
  <!-- end: #footer -->

</div>

</body>
</html>
