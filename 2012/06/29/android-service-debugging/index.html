<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns:wb="http://open.weibo.com/wb">
<head>
<title>Lucas Xu : How does an Android developer fix a bug? </title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="language" content="en" />
<link rel="stylesheet" type="text/css" href="/css/default.css" />
<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
<meta property="wb:webmaster" content="85ada6b02f0f02d5" />
<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=4064321344" type="text/javascript" charset="utf-8"></script>

<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32905076-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>














<body>
<div class="page_margins">
  <div id="header">
    <h2><a href="http://xianminx.github.com">Lucas Xu   徐仙明</a></h2>
    <div class="clear"></div>

    <!-- begin: main navigation #nav -->
    <div id="nav">
      <div class="hlist">
        <ul>
          
          <li>
          <a href="/about/">About</a>
          </li>
          
          <li class="active">
          <a href="/">Blog</a>
          </li>
          
          <li>
          <a href="/archives/">Archives</a>
          </li>
          
          <li>
          <a href="/tags/">Categories</a>
          </li>
          
          <li>
          <a href="/other/">Other</a>
          </li>
          
          <li><a href="http://github.com/xianminx">Repositories</a></li>
        </ul>
      </div>
    </div>
    <!-- end: main navigation -->
  </div>

  <!-- begin: main content area #main -->
  <div id="main">
    <div id="col1">
      <div id="col1_content">
        <div class="post">
  <h3>How does an Android developer fix a bug?</h3>


<!-- JiaThis Button BEGIN -->
<div id="ckepop">
  <span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_tsina">新浪微博</a>
	<a class="jiathis_button_googleplus">Google+</a>
	<a class="jiathis_button_fb">Facebook</a>
	<a class="jiathis_button_evernote">EverNote</a>
	<a class="jiathis_button_tqq">腾讯微博</a>
	<a href="http://www.jiathis.com/share?uid=1633146" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1336370704363698" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!-- UJian Button BEGIN -->
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide"></script>
<!-- UJian Button END -->

<script type="text/javascript">
var jiathis_config = {
    shareImg:{
        "showType":"ALL",
        "bgColor":"",
        "txtColor":"",
        "text":"",
        "services":"",
        "position":"",
        "imgwidth":"",
        "imgheight":"",
        "divname":""
    }
}
</script>
<script type='text/javascript' src='http://v2.jiathis.com/code/jia.js?uid=1336370704363698' charset='utf-8'></script>



<br/>

  <p>Day and day ago, I wrote a <code>DownloadingService</code> for Android application. The service is provided in an Android SDK, which ill be utilized by other android apps. Some app developers wrote their code in such as way that when user press BACK button on Android, the app will <em>kill</em> itself in such a way: </p>
<div class="highlight"><pre><code class="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onKeyDown</span><span class="o">(</span><span class="kt">int</span> <span class="n">keyCode</span><span class="o">,</span> <span class="n">KeyEvent</span> <span class="n">event</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">keyCode</span> <span class="o">==</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">KEYCODE_BACK</span><span class="o">))</span>
    <span class="o">{</span>
       <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">killProcess</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">())</span> <span class="o">;</span>
       <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onKeyDown</span><span class="o">(</span><span class="n">keyCode</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<p>As an advanced Android developer, you may think how this could be stupid and violate the design principle of Android Framework, i.e., &quot;Activity&quot; should follow it&#39;s own <a href="http://developer.android.com/reference/android/app/Activity.html">lifecycle</a>.</p>

<p>But as the old saying said, customer is our God. SDK users, some could be novice android develoeprs, they refuse to change their existing strucutre and insist to kill the process when back button is pressed. As a result, the &quot;DownloadingService&quot; is also killed as it resides in the app&#39;s main proces. </p>

<p>Though the phenomenon is expected, the novice developer does not think so. They want the DownloadingService to continue download files from the Internet even though they killed the main app process. To make a concession, I changed the &quot;DownloadingSercie&quot; so it runs in a separate process. 
This is fair easy. Developer only has to mark the service as &quot;exported&quot; in &quot;AndroidManifest.xml&quot;. </p>
<div class="highlight"><pre><code class="xml"><span class="nt">&lt;service</span>
    <span class="na">android:name=</span><span class="s">&quot;com.example.net.DownloadingService&quot;</span>
    <span class="na">android:exported=</span><span class="s">&quot;true&quot;</span>
    <span class="na">android:process=</span><span class="s">&quot;:DownloadingService&quot;</span> <span class="nt">&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</code></pre>
</div>

<blockquote>
<p>Everything goes well until one day.</p>
</blockquote>

<p>One developer reported under the scenario he created, the DownloadingService could not correctly download the file:</p>

<ol>
<li>Start the app, click download</li>
<li>Exit the app using &quot;BACK&quot; button, which kills app&#39;s main process. </li>
<li>Restart the app, click download (the same url as the Step 1). He observes that even though the url is the same as Step 1, there will be another notification bar item. 
The first download task is still excuting (from the notification bar). </li>
</ol>

<p>This is absolutely unexpected, as I added code for this kind of duplicate check. If the url is in downloaing task list, it will not be downloaded again. DownloadingService generates a file name based on url (MD5 hash of the url) along with the file extension, plus suffix &quot;.tmp&quot;, then saves it to SD card. After the file is complete downloaded, the file will be renamed to remove suffix &quot;.tmp&quot;. Here the duplicate check code did not work!</p>

<p>Here it is: </p>
<div class="highlight"><pre><code class="java">    <span class="cm">/**</span>
<span class="cm">     * Check if the download request is already processed and is in downloading.</span>
<span class="cm">     * </span>
<span class="cm">     * @param item</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isInDownloadList</span><span class="o">(</span><span class="n">DownloadItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mClients</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">DownloadItem</span> <span class="n">d</span> <span class="o">:</span> <span class="n">mClients</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">d</span><span class="o">.</span><span class="na">mUrl</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">mUrl</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>mClients is declared as DownloadingService&#39;s class member:</p>
<div class="highlight"><pre><code class="java">    <span class="c1">// The clients connected to the service. Messenger references the client,</span>
    <span class="c1">// where DownloadItem specifies the information required by this service.</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DownloadAgent</span><span class="o">.</span><span class="na">DownloadItem</span><span class="o">,</span> <span class="n">Messenger</span><span class="o">&gt;</span> <span class="n">mClients</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DownloadAgent</span><span class="o">.</span><span class="na">DownloadItem</span><span class="o">,</span> <span class="n">Messenger</span><span class="o">&gt;();</span>
</code></pre>
</div>

<p><code>mClient</code> as a <code>Map</code> records all downloading url. If a url is in downloading, it can&#39;t be downloaded again. So no reason that a duplicate url can be added to <code>mClients</code>. It is so strange. </p>

<p>Each single line of code looks fine to me. </p>

<p>Then I launch the debug mode, for both the main process and DownloadingService process. </p>
<div class="highlight"><pre><code class="java">    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;onCreate &quot;</span><span class="o">);</span>
        <span class="c1">// uncomment the following line to enable inter-process debug.</span>
        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Debug</span><span class="o">.</span><span class="na">waitForDebugger</span><span class="o">();</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>The trace tells that in Step 3, <code>mClients</code> is empty: no elements is added before. This is so abnormal. What happened?</p>

<p>Obviously the Process is still living there, otherwise, the first task cannot continue executing. Recalling from Android API description, the service runs in the main thread of its process. I doubt if the service was destroyed and re-created. After adding log information in it&#39;s <code>onCreate</code>  and <code>onDestroy</code> method, yes! The service was destroyed and re-created again. But the process id and thread id are the same. </p>
<div class="highlight"><pre><code class="java">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isInDownloadList</span><span class="o">(</span><span class="n">DownloadItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;pid = &quot;</span> <span class="o">+</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">());</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;threadid = &quot;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mClients</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">DownloadItem</span> <span class="n">d</span> <span class="o">:</span> <span class="n">mClients</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">d</span><span class="o">.</span><span class="na">mUrl</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">mUrl</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre>
</div>

<p><code>threadid</code> shows &#39;1&#39; for both Step 1 and Step 3.</p>

<p>I was really confused. It seems Step 1 and Step 3 were in the same thread. But if that&#39;s the case, why data stored in &#39;mClients&#39; is losed?
Hinted by the number &#39;1&#39;, I guess the thread might be killed and re-created, but the thread number was reused as OS find the number can be re-allocated the second time as it realize that no other thread is using this id. </p>

<p>So to make the intestigation a further step, I added a member </p>
<div class="highlight"><pre><code class="java"><span class="kd">class</span> <span class="nc">DownloadingService</span> <span class="kd">extends</span> <span class="n">Service</span><span class="o">{</span>
    <span class="c1">// generate an random id each time a class instance is created. In this case, it means a new thread is created.  </span>
    <span class="kt">int</span> <span class="n">thread_random_id</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>

    <span class="c1">// ....</span>
<span class="o">}</span>
</code></pre>
</div>

<p>A-ha, <code>thread_random_id</code> is different for the 2 cases!</p>

<p><code>DownloadingService</code> is killed and re-created! 
The first task is still downloading because the task was launched in a different thread other than the Service thread itself.</p>

<p>To resolve the issue, simply make <code>mClient</code> <code>static</code>. </p>
<div class="highlight"><pre><code class="java">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">DownloadAgent</span><span class="o">.</span><span class="na">DownloadItem</span><span class="o">,</span> <span class="n">Messenger</span><span class="o">&gt;</span> <span class="n">mClients</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">DownloadAgent</span><span class="o">.</span><span class="na">DownloadItem</span><span class="o">,</span> <span class="n">Messenger</span><span class="o">&gt;();</span>
</code></pre>
</div>

<p>To be continued: why Service thread is killed and re-created?</p>

</div>

<small class="meta final">
  29 Jun 2012
  
   | 
  <a href='/tags#android'>android</a>, 
  
  
  <a href='/tags#debug'>debug</a>
  

</small>
<!-- 新浪微薄 评论箱 -->
<script type="text/javascript">
(function(){
var url = "http://widget.weibo.com/distribution/comments.php?width=0&url=auto&ralateuid=2063991842&appkey=4064321344&dpc=1";
url = url.replace("url=auto", "url=" + document.URL); 
document.write('<iframe id="WBCommentFrame" src="' + url + '" scrolling="no" frameborder="0" style="width:100%"></iframe>');
})();
</script>
<script src="http://tjs.sjs.sinajs.cn/open/widget/js/widget/comment.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
window.WBComment.init({
    "id": "WBCommentFrame"
});
</script>
<!-- 新浪微薄 评论箱 -->


<!-- Google Analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32905076-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

      </div>
    </div>
    <div id="col3">
      <div id="col3_content">
        <h6 class="vlist">GitHub projects</h6>
        <ul class="vlist">
        	<li>
			<a href="https://github.com/xianminx/PullToRefresh-ListView" >PullToRefresh-ListView</a>
		</li>
	</ul>
        <h6 class="vlist">Misc. Links</h6>
        <ul class="vlist">
          <li>
            <a
              href="http://android-developers.blogspot.com/"
              ><img src="http://android-developers.blogspot.kr/favicon.ico"/>Android Developers Blog</a>
          </li>
          <li>
            <a
              href="http://saigeethamn.blogspot.com/"
              ><img src="https://www.blogger.com/img/logo-16.png"/> Sai Geetha's Android blog</a>
          </li>
          </ul>

<!-- AddThis Follow BEGIN -->
<h6 class="vlist">Follow Me</h6>
<br/>
<div class="addthis_toolbox addthis_32x32_style addthis_default_style">
<a class="addthis_button_google_follow" addthis:userid="101226668323584222394"></a>
<a class="addthis_button_facebook_follow" addthis:userid="xianminx"></a>
<a class="addthis_button_linkedin_follow" addthis:userid="xianminx"></a>
<a class="addthis_button_twitter_follow" addthis:userid="xianminx"></a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-4fdf49b46dac2571"></script>
<!-- AddThis Follow END -->

<br/>

<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=300&skin=1&isTitle=1&noborder=0&isWeibo=1&isFans=1&uid=2063991842&verifier=e0e8dc08&dpc=1"></iframe>


</div>
    </div>
    <div class="clear"></div>
  </div>
  <!-- end: #main -->

  <!-- begin: #footer -->
  <div id="footer">
    <div class="hlist">
      <ul>
        
        <li>
        <a href="/about/"
        
        >About</a>
         | 
        </li>
        
        <li class="active">
        <a href="/"
        
        >Blog</a>
         | 
        </li>
        
        <li>
        <a href="/archives/"
        
        >Archives</a>
         | 
        </li>
        
        <li>
        <a href="/tags/"
        
        >Categories</a>
         | 
        </li>
        
        <li>
        <a href="/other/"
        
        >Other</a>
        
        </li>
        
        <li>&ndash; updated 2012-07-07</li>
      </ul>
    </div>
  </div>
  <!-- end: #footer -->

</div>

</body>
</html>
